/******  Copyright 2016 Tradable ApS; @license MIT; v1.11  ******/
window.trEmbJQ=jQuery.noConflict(!0),("undefined"==typeof window.console||"undefined"==typeof window.console.log)&&(window.console={log:function(){}}),window.tradableEmbed=function(e){"use strict";function t(){function t(t,o){var c,r,a;o.tradingEnabled=!1,n()&&localStorage.setItem("tradingEnabled:"+m,!1);var i=t.replace("#","").split("&");return e(i).each(function(e,t){var n=t.split("="),o=n[0],i=n[1];"access_token"===o?c=i:"endpointURL"===o?r=i:"expires_in"===o&&(a=i)}),c&&r?(o.enableTrading(c,r,a),"osLaunch"===window.name&&window.close(),!0):!1}var o=!1,r=window.opener;if(r&&"osAddBroker"===window.name){try{r.tradableEmbed.enableTrading(void 0,void 0,void 0,!0)}catch(a){}window.close()}else if(r&&"osLaunch"===window.name){var i=window.location.hash;if(i){try{r.postMessage("replace your location","*"),o=t(i,r.tradableEmbed)}catch(a){o=!1}o||(o=t(i,U))}}else window.location.hash&&-1!==window.location.hash.indexOf("access_token")&&-1!==window.location.hash.indexOf("endpointURL")&&-1!==window.location.hash.indexOf("expires_in")?o=t(window.location.hash,U):U.tradingEnabled&&(s(),o=!0);o||(console.log("Initiating without authentication..."),e(document).ready(function(){c()}))}function n(){var e="test";try{return localStorage.setItem(e,"1"),localStorage.removeItem(e),!0}catch(t){return!1}}function o(e,t,n,o){var c=window.screenLeft?window.screenLeft:window.screenX,r=window.screenTop?window.screenTop:window.screenY,a=c+window.innerWidth/2-n/2,i=r+window.innerHeight/2-o/2;return window.open(e,t,"toolbar=no, titlebar=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+n+", height="+o+", top="+i+", left="+a)}function c(){e(U.readyCallbacks).each(function(e,t){t()}),U.notifiedCallbacks=!0}function r(){U.tradingEnabled=!1,n()&&localStorage.setItem("tradingEnabled:"+m,!1),e(F).each(function(e,t){t()}),c()}function a(t){e(C).each(function(e,n){n(t)})}function i(){e(S).each(function(e,t){t()})}function u(t,n){console.log("Initializing values for current account");var o=!1;return U.tradingEnabled&&(U.tradingEnabled=!1,o=!0),U.getInstruments().then(function(n){U.availableCategories.splice(0,U.availableCategories.length),U.availableInstruments.splice(0,U.availableInstruments.length),U.availableSymbols.splice(0,U.availableSymbols.length),U.availableCurrencies.splice(0,U.availableCurrencies.length);var c=["100","200","225","spx","h33","nas","u30","e50","f40","d30","e35","i40","z30","s30","uso","uko"];return e(n).each(function(t,n){if(U.availableInstruments.push(n),U.availableSymbols.push(n.symbol),"FOREX"===n.type&&6===n.symbol.length){var o=n.symbol.toLowerCase().substring(0,3),r=n.symbol.toLowerCase().substring(3,6);-1===e.inArray(o,U.availableCurrencies)&&-1===e.inArray(o,c)&&U.availableCurrencies.push(o),-1===e.inArray(r,U.availableCurrencies)&&-1===e.inArray(o,c)&&U.availableCurrencies.push(r)}-1===e.inArray(n.type,U.availableCategories)&&U.availableCategories.push(n.type)}),o&&(U.tradingEnabled=!0),i(),t&&"function"==typeof t?t(U.accounts):this},function(e){return n&&"function"==typeof n?n(e):this})}function s(){console.log("Validating token..."),U.getAccounts().then(function(e){U.enableTrading(U.accessToken,U.authEndpoint)},function(){U.tradingEnabled=!1,n()&&localStorage.setItem("tradingEnabled:"+m,U.tradingEnabled),c()})}function l(e,t){console.log("Accounts initialized");var n,o=localStorage.getItem("selectedAccount:"+m);if(e&&U.accounts.length>t){var r=U.accounts.length-1;n=U.accounts[r].uniqueId}else if(o&&U.accountMap[o])n=o;else{var r=U.accounts.length-1;n=U.accounts[r].uniqueId}U.setSelectedAccount(n,function(){c()})}function d(){if(U.tradingEnabled&&!q){q=!0;var t=[];e(U.symbolKeysForAccountUpdates).each(function(n,o){var c=o.substring(0,o.indexOf(":"));-1===e.inArray(c,t)&&t.push(c)}),U.getSnapshot(t).then(function(t){U.lastSnapshot=t,e.each(P,function(e,n){n(t)}),q=!1},function(){q=!1})}}function f(e){var t;return t=e?U.auth_loc+"&broker_id="+e:U.auth_loc}function p(e){var t=0;if(0==e.length)return t;for(M=0;M<e.length;M++)L=e.charCodeAt(M),t=(t<<5)-t+L,t&=t;return t}function g(){return-1!=navigator.userAgent.indexOf("MSIE")||/rv:11.0/i.test(navigator.userAgent)}var m,A,h="js-1.11",b=location.href;if("undefined"!=typeof tradableEmbedConfig)m=tradableEmbedConfig.appId,A=tradableEmbedConfig.customOAuthURL,tradableEmbedConfig.redirectURI&&(b=tradableEmbedConfig.redirectURI);else{var v="tradable-embed";0==e("#"+v).length&&(v="tradable-api"),m=e("#"+v).attr("data-app-id"),A=e("#"+v).attr("data-custom-oauth-url");var y=e("#"+v).attr("data-redirect-uri");y&&(b=y)}var T="api.tradable.com";m>2e5&&(T="api-staging.tradable.com",console.log("Starting in staging mode..."));var I=localStorage.getItem("accessToken:"+m),E=localStorage.getItem("authEndpoint:"+m),k=localStorage.getItem("tradingEnabled:"+m),O=localStorage.getItem("expirationTimeUTC:"+m);!k||E&&I&&O||(k=!1,n()&&localStorage.setItem("tradingEnabled:"+m,k));var S=[],P=[],w=[],F=[],R=[],C=[],q=!1,U={app_id:m,oauth_host:T,auth_loc:A?A:"https://"+T+"/oauth/authorize?client_id="+m+"&scope=trade&response_type=token&redirect_uri="+b,add_broker_loc:"https://"+T+"/addBroker?clientId="+m+"&redirectURI="+b,auth_window:null,authEndpoint:E,accessToken:I,notifiedCallbacks:!1,tradingEnabled:k,expirationTimeUTC:O,readyCallbacks:[],accounts:[],accountIdsToExclude:[],accountMap:{},selectedAccount:null,selectedAccountId:null,availableCategories:[],availableInstruments:[],availableSymbols:[],availableCurrencies:[],lastSnapshot:null,symbolKeysForAccountUpdates:[],accountUpdateInterval:null,accountUpdateMillis:700,authenticate:function(e){console.log("Starting oauth flow..."),U.tradingEnabled?s():location.href=f(e)},authenticateWithWindow:function(e){return g()?(console.log("Window opener no supported in IE, redirecting to oauth..."),U.authenticate(e)):(console.log("Opening oauth window..."),void(U.auth_window=o(f(e),"osLaunch",450,450)))},openAddBrokerWindow:function(){g()&&window.open("https://api.tradable.com"),U.auth_window=o(U.add_broker_loc,"osAddBroker",450,450)},enableWithAccessToken:function(e,t,n){U.enableTrading(e,t,n,!0)},signOut:function(){n()&&(localStorage.removeItem("accessToken:"+m),localStorage.removeItem("authEndpoint:"+m),localStorage.removeItem("tradingEnabled:"+m),localStorage.removeItem("expirationTimeUTC:"+m)),U.tradingEnabled=!1,c()},onEmbedReady:function(e){U.readyCallbacks.push(e),U.notifiedCallbacks&&e()},onAccountUpdated:function(t){if(t){0===P.length&&(U.accountUpdateInterval=setInterval(d,U.accountUpdateMillis));var n=p(t.toString());-1===e.inArray(n,w)&&(P.push(t),w.push(n))}},setAccountUpdateFrequencyMillis:function(e){e&&e>0?(U.accountUpdateMillis=e,U.accountUpdateInterval&&(clearInterval(U.accountUpdateInterval),U.accountUpdateInterval=setInterval(d,U.accountUpdateMillis))):console.error("Please specify a valid update frequency")},addSymbolToUpdates:function(t,n){if(-1!==t.indexOf(":"))return void console.error("It is not allowed to include a colon ':' in the updateClientId");var o=n+":"+t;-1===e.inArray(o,U.symbolKeysForAccountUpdates)&&-1!==e.inArray(n,U.availableSymbols)&&U.symbolKeysForAccountUpdates.push(o)},removeSymbolFromUpdates:function(t,n){var o=n+":"+t;U.symbolKeysForAccountUpdates=e.grep(U.symbolKeysForAccountUpdates,function(e){return e!=o})},onAccountSwitch:function(t){t&&-1===e.inArray(t,S)&&S.push(t)},onTokenExpired:function(t){t&&-1===e.inArray(t,F)&&F.push(t)},onError:function(t){-1===e.inArray(t,C)&&C.push(t)},onTokenWillExpire:function(t){function n(){var t=U.getRemainingTokenMillis();t&&t>0&&18e5>t&&e(R).each(function(e,n){n(t)})}0===R.length&&setInterval(n,3e5),-1===e.inArray(t,R)&&R.push(t)},getRemainingTokenMillis:function(){return U.expirationTimeUTC||console.log("You need to authenticate before calling this method"),U.expirationTimeUTC-(new Date).getTime()},makeOsRequest:function(t,n,o,c,i,u,s){var l;"apps"===t||"brokers"===t?l="https://"+T:void 0!==o&&null!==o&&0===o.length?l=U.authEndpoint:U.accountMap[o]?l=U.accountMap[o].endpointURL:console.info("Please specify a valid accountId or method");var d=e.ajax({type:n,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+U.accessToken),e.setRequestHeader("x-tr-embed-sdk",h)},crossDomain:!0,url:o&&o.length>0?l+"/v1/"+t+"/"+o+"/"+c:l+"/v1/"+t+"/"+c,contentType:"application/json; charset=utf-8",data:i?JSON.stringify(i):void 0,dataType:"json"});return d.then(function(){},function(e,t,n){!e.responseJSON||403!==e.responseJSON.httpStatus&&502!==e.responseJSON.httpStatus||(r(),a(e.responseJSON))}),u||s?d.then(function(e){return"function"==typeof u?u(e):void 0},function(e,t,n){return"function"==typeof s?s(e,t,n):void 0}):"undefined"!=typeof Promise&&-1!==Promise.toString().indexOf("[native code]")?Promise.resolve(d):d},makeAccountRequest:function(e,t,n,o,c,r){return U.makeOsRequest("accounts",e,t,n,o,c,r)},setSelectedAccount:function(e,t,o){return U.accountMap[e]?(U.selectedAccount=U.accountMap[e],U.selectedAccountId=e,u(function(){n()&&localStorage.setItem("selectedAccount:"+m,e),t&&t()},function(e){(502===e.status||403===e.status)&&(U.excludeCurrentAccount(),U.accounts.length>0&&s()),o&&o(e)})):void console.error("Can't set account id to: "+e)},excludeCurrentAccount:function(){var e=U.selectedAccountId,t=U.accounts.indexOf(U.selectedAccount);t>-1&&U.accounts.splice(t,1),delete U.accountMap[e],U.accountIdsToExclude.push(e)},getInstrumentFromSymbol:function(t){if(!t)return null;var n=null;return e(U.availableInstruments).each(function(e,o){return o.symbol.toUpperCase()===t.toUpperCase()?(n=o,!1):void 0}),n},getInstrumentFromBrokerageAccountSymbol:function(t){var n=null;return e(U.availableInstruments).each(function(e,o){return o.brokerageAccountSymbol.toUpperCase()===t.toUpperCase()?(n=o,!1):void 0}),n},getAccountById:function(e){return U.accountMap[e]},getUser:function(e,t){return U.makeOsRequest("user","GET","","",null,e,t)},getAppInfo:function(e,t){return U.makeOsRequest("apps","GET","",U.app_id,null,e,t)},getBrokers:function(e,t){return U.makeOsRequest("brokers","GET","","",null,e,t)},getAccounts:function(t,n){var o=U.makeAccountRequest("GET","","",null).then(function(t){U.accounts.splice(0,U.accounts.length),U.accountMap={},e(t.accounts).each(function(e,t){t.uniqueId&&"NA"!==t.uniqueId&&U.accountIdsToExclude.indexOf(t.uniqueId)<=-1&&(U.accounts.push(t),U.accountMap[t.uniqueId]=t)})});return t||n?o.then(function(e){return"function"==typeof t?t(e):void 0},function(e,t,o){return"function"==typeof n?n(e,t,o):void 0}):o},getCandles:function(e,t,n,o,c,r){return U.getCandlesForAccount(U.selectedAccountId,e,t,n,o,c,r)},getCandlesForAccount:function(e,t,n,o,c,r,a){var i={symbol:t,from:n,to:o,aggregation:c};return U.makeAccountRequest("POST",e,"candles/",i,r,a)},getSnapshot:function(e,t,n){return U.getSnapshotForAccount(U.selectedAccountId,e,t,n)},getSnapshotForAccount:function(e,t,n,o){var c={symbols:t};return U.makeAccountRequest("POST",e,"",c,n,o)},getInstruments:function(e,t){return U.getInstrumentsForAccount(U.selectedAccountId,e,t)},getInstrumentsForAccount:function(e,t,n){return U.makeAccountRequest("GET",e,"instruments/",null,t,n)},getMetrics:function(e,t){return U.getMetricsForAccount(U.selectedAccountId,e,t)},getMetricsForAccount:function(e,t,n){return U.makeAccountRequest("GET",e,"metrics/",null,t,n)},getOrders:function(e,t){return U.getOrdersForAccount(U.selectedAccountId,e,t)},getOrdersForAccount:function(e,t,n){return U.makeAccountRequest("GET",e,"orders/",null,t,n)},placeMarketOrder:function(e,t,n,o,c){return U.placeOrder(e,0,t,n,"MARKET",o,c)},placeMarketOrderForAccount:function(e,t,n,o,c,r){return U.placeOrderForAccount(e,t,0,n,o,"MARKET",c,r)},placeLimitOrder:function(e,t,n,o,c,r){return U.placeOrder(e,t,n,o,"LIMIT",c,r)},placeLimitOrderForAccount:function(e,t,n,o,c,r,a){return U.placeOrderForAccount(e,t,n,o,c,"LIMIT",r,a)},placeStopOrder:function(e,t,n,o,c,r){return U.placeOrder(e,t,n,o,"STOP",c,r)},placeStopOrderForAccount:function(e,t,n,o,c,r,a){return U.placeOrderForAccount(e,t,n,o,c,"STOP",r,a)},placeOrder:function(e,t,n,o,c,r,a){return U.placeOrderForAccount(U.selectedAccountId,e,t,n,o,c,r,a)},placeOrderForAccount:function(e,t,n,o,c,r,a,i){var u={amount:t,price:n,side:o,symbol:c,type:r};return U.makeAccountRequest("POST",e,"orders/",u,a,i)},getPendingOrders:function(e,t){return U.getPendingOrdersForAccount(U.selectedAccountId,e,t)},getPendingOrdersForAccount:function(e,t,n){return U.makeAccountRequest("GET",e,"orders/pending",null,t,n)},getOrderById:function(e,t,n){return U.getOrderByIdForAccount(U.selectedAccountId,e,t,n)},getOrderByIdForAccount:function(e,t,n,o){return U.makeAccountRequest("GET",e,"orders/"+t,null,n,o)},modifyOrderPrice:function(e,t,n,o){return U.modifyOrderPriceForAccount(U.selectedAccountId,e,t,n,o)},modifyOrderPriceForAccount:function(e,t,n,o,c){var r={price:n};return U.makeAccountRequest("PUT",e,"orders/"+t,r,o,c)},cancelOrder:function(e,t,n){return U.cancelOrderForAccount(U.selectedAccountId,e,t,n)},cancelOrderForAccount:function(e,t,n,o){return U.makeAccountRequest("DELETE",e,"orders/"+t,null,n,o)},getPositions:function(e,t){return U.getPositionsForAccount(U.selectedAccountId,e,t)},getPositionsForAccount:function(e,t,n){return U.makeAccountRequest("GET",e,"positions/",null,t,n)},closeAllPositions:function(e,t){return U.closeAllPositionsForAccount(U.selectedAccountId,e,t)},closeAllPositionsForAccount:function(e,t,n){return U.makeAccountRequest("DELETE",e,"positions/",null,t,n)},getOpenPositions:function(e,t){return U.getOpenPositionsForAccount(U.selectedAccountId,e,t)},getOpenPositionsForAccount:function(e,t,n){return U.makeAccountRequest("GET",e,"positions/open",null,t,n)},getPositionById:function(e,t,n){return U.getPositionByIdForAccount(U.selectedAccountId,e,t,n)},getPositionByIdForAccount:function(e,t,n,o){return U.makeAccountRequest("GET",e,"positions/"+t,null,n,o)},reducePositionToAmount:function(e,t,n,o){return U.reducePositionToAmountForAccount(U.selectedAccountId,e,t,n,o)},reducePositionToAmountForAccount:function(e,t,n,o,c){var r={amount:n};return U.makeAccountRequest("PUT",e,"positions/"+t,r,o,c)},closePosition:function(e,t,n){return U.closePositionForAccount(U.selectedAccountId,e,t,n)},closePositionForAccount:function(e,t,n,o){return U.makeAccountRequest("DELETE",e,"positions/"+t,null,n,o)},addOrModifyProtections:function(e,t,n,o,c){return U.addOrModifyProtectionsForAccount(U.selectedAccountId,e,t,n,o,c)},addOrModifyProtectionsForAccount:function(e,t,n,o,c,r){var a={takeprofit:n,stoploss:o};return U.makeAccountRequest("PUT",e,"positions/"+t+"/protections/",a,c,r)},cancelProtections:function(e,t,n){return U.cancelProtectionsForAccount(U.selectedAccountId,e,t,n)},cancelProtectionsForAccount:function(e,t,n,o){return U.makeAccountRequest("DELETE",e,"positions/"+t+"/protections/",null,n,o)},addOrModifyTakeProfit:function(e,t,n,o){return U.makeProtectionRequest("PUT",e,t,"TAKEPROFIT",n,o)},addOrModifyTakeProfitForAccount:function(e,t,n,o,c){return U.makeProtectionRequestForAccount("PUT",e,t,n,"TAKEPROFIT",o,c)},addOrModifyStopLoss:function(e,t,n,o){return U.makeProtectionRequest("PUT",e,t,"STOPLOSS",n,o)},addOrModifyStopLossForAccount:function(e,t,n,o,c){return U.makeProtectionRequestForAccount("PUT",e,t,n,"STOPLOSS",o,c)},cancelTakeProfit:function(e,t,n){return U.makeProtectionRequest("DELETE",e,0,"TAKEPROFIT",t,n)},cancelTakeProfitForAccount:function(e,t,n,o){return U.makeProtectionRequestForAccount("DELETE",e,t,0,"TAKEPROFIT",n,o)},cancelStopLoss:function(e,t,n){return U.makeProtectionRequest("DELETE",e,0,"STOPLOSS",t,n)},cancelStopLossForAccount:function(e,t,n,o){return U.makeProtectionRequestForAccount("DELETE",e,t,0,"STOPLOSS",n,o)},makeProtectionRequest:function(e,t,n,o,c,r){return U.makeProtectionRequestForAccount(e,U.selectedAccountId,t,n,o,c,r)},makeProtectionRequestForAccount:function(e,t,n,o,c,r,a){var i={price:o};return"DELETE"===e&&(i=null),U.makeAccountRequest(e,t,"positions/"+n+"/protections/"+c,i,r,a)},getPrices:function(e,t,n){return U.getPricesForAccount(U.selectedAccountId,e,t,n)},getPricesForAccount:function(e,t,n,o){var c={symbols:t};return U.makeAccountRequest("POST",e,"prices/",c,n,o)},makeCandleRequest:function(t,n,o,c,r){var a={symbols:n};r&&(a=r);var i=e.ajax({type:"POST",crossDomain:!0,url:"https://candles-api.tradable.com/"+t,contentType:"application/json; charset=utf-8",data:JSON.stringify(a),dataType:"json"});if(o||c)return i.then(function(e){return"function"==typeof o?o(e.dailyClose?e.dailyClose:e):void 0},function(e,t,n){return"function"==typeof c?c(e,t,n):void 0});var u=new e.Deferred;return i.then(function(e){return e.dailyClose?u.resolve(e.dailyClose):u.resolve(e)},function(e,t,n){return u.reject(e,t,n)}),"undefined"!=typeof Promise&&-1!==Promise.toString().indexOf("[native code]")?Promise.resolve(u.promise()):u.promise()},getLastDailyClose:function(e,t,n){return U.makeCandleRequest("dailyClose",e,t,n)},enableTrading:function(e,t,o,c){console.log("Activating TradableEmbed..."),e&&t&&(U.accessToken=e,U.authEndpoint=t,U.tradingEnabled=!0,n()&&(localStorage.setItem("accessToken:"+m,U.accessToken),localStorage.setItem("authEndpoint:"+m,U.authEndpoint),localStorage.setItem("tradingEnabled:"+m,U.tradingEnabled),o&&(U.expirationTimeUTC=(new Date).getTime()+1e3*parseInt(o),localStorage.setItem("expirationTimeUTC:"+m,U.expirationTimeUTC))));var r=U.accounts.length;U.getAccounts().then(function(e){l(c,r)})}};return t(),U;var M,L}(trEmbJQ);